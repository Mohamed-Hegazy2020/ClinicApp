name: Deploy ASP.NET Core to MonsterASP.NET via Web Deploy

on:
  push:
    branches:
      - main   # Deploy on push to main branch

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '7.0.x' # Use your project .NET version

    - name: Restore dependencies
      run: dotnet restore

    - name: Build and publish
      run: dotnet publish ./YourProject.csproj -c Release -o publish

    - name: Deploy via Web Deploy
      shell: pwsh
      run: |
        $publishSettings = @{
          ComputerName = $Env:WEBDEPLOY_SERVER
          UserName     = $Env:WEBDEPLOY_USERNAME
          Password     = $Env:WEBDEPLOY_PASSWORD
          SiteName     = $Env:WEBDEPLOY_SITE
          SourcePath   = "publish"
        }

        # Install Web Deploy if not installed
        if (-not (Get-Command msdeploy -ErrorAction SilentlyContinue)) {
          Write-Host "Installing Web Deploy..."
          choco install webdeploy -y
        }

        # Deploy the app
        msdeploy.exe `
          -source:contentPath="$($publishSettings.SourcePath)" `
          -dest:contentPath="$($publishSettings.SiteName)",computerName="$($publishSettings.ComputerName)",userName="$($publishSettings.UserName)",password="$($publishSettings.Password)",authType="Basic" `
          -allowUntrusted

      env:
        WEBDEPLOY_SERVER: ${{ secrets.WEBDEPLOY_SERVER }}   # e.g., https://yourserver:8172/msdeploy.axd
        WEBDEPLOY_USERNAME: ${{ secrets.WEBDEPLOY_USERNAME }}
        WEBDEPLOY_PASSWORD: ${{ secrets.WEBDEPLOY_PASSWORD }}
        WEBDEPLOY_SITE: ${{ secrets.WEBDEPLOY_SITE }}       # Your MonsterASP.NET site name
