name: CI/CD - Deploy ClinicApp to MonsterASP.NET

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'   # change if needed

    - name: Restore solution
      run: dotnet restore ClinicApp.sln

    - name: Publish web project
      run: dotnet publish App.Presentation/App.Presentation.csproj -c Release -o publish

    - name: Deploy to MonsterASP.NET via Web Deploy
      shell: pwsh
      run: |
        $msdeploy = "C:\Program Files\IIS\Microsoft Web Deploy V3\msdeploy.exe"

        if (!(Test-Path $msdeploy)) {
          throw "msdeploy.exe not found"
        }

        Write-Host "Deploying to MonsterASP.NET..."

        & $msdeploy `
          "-verb:sync" `
          "-source:contentPath=$Env:WEBDEPLOY_SITE" `
          "-dest:contentPath=$Env:WEBDEPLOY_SITE,computerName=$Env:WEBDEPLOY_SERVER,userName=$Env:WEBDEPLOY_USERNAME,password=$Env:WEBDEPLOY_PASSWORD,authType=Basic" `
          "-allowUntrusted"
      env:
        WEBDEPLOY_SERVER: ${{ secrets.WEBDEPLOY_SERVER }}
        WEBDEPLOY_USERNAME: ${{ secrets.WEBDEPLOY_USERNAME }}
        WEBDEPLOY_PASSWORD: ${{ secrets.WEBDEPLOY_PASSWORD }}
        WEBDEPLOY_SITE: ${{ secrets.WEBDEPLOY_SITE }}
