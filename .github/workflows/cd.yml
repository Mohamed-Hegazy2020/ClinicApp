name: CI/CD - Deploy ClinicApp to MonsterASP.NET

on:
  push:
    branches:
      - main  # Deploy on push to main branch

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    # 1️Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2️Setup .NET SDK
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'  # Adjust to your .NET version

    # 3️Restore NuGet packages
    - name: Restore dependencies
      run: dotnet restore ClinicApp.sln

    # 4️Build & publish the solution
    - name: Build and publish
      run: dotnet publish ClinicApp.sln -c Release -o publish

    # 5️Deploy via Web Deploy
    - name: Deploy via Web Deploy
      shell: pwsh
      run: |
        # Setup deployment variables
        $publishSettings = @{
            ComputerName = $Env:WEBDEPLOY_SERVER
            UserName     = $Env:WEBDEPLOY_USERNAME
            Password     = $Env:WEBDEPLOY_PASSWORD
            SiteName     = $Env:WEBDEPLOY_SITE
            SourcePath   = "publish"
        }

        # Path to msdeploy.exe
        $msdeployPath = "C:\Program Files\IIS\Microsoft Web Deploy V3\msdeploy.exe"

        # Check if msdeploy exists
        if (-Not (Test-Path $msdeployPath)) {
            Write-Error "Web Deploy not found at $msdeployPath"
            exit 1
        }

        Write-Host "Deploying ClinicApp via Web Deploy..."

        # Build msdeploy arguments as array (reliable in PowerShell)
        $msdeployArgs = @(
            "-source", "contentPath=$($publishSettings.SourcePath)"
            "-dest", "contentPath=$($publishSettings.SiteName),computerName=$($publishSettings.ComputerName),userName=$($publishSettings.UserName),password=$($publishSettings.Password),authType=Basic"
            "-verb:sync"
            "-allowUntrusted"
        )

        # Run msdeploy
        & $msdeployPath @msdeployArgs
      env:
        WEBDEPLOY_SERVER: ${{ secrets.WEBDEPLOY_SERVER }}
        WEBDEPLOY_USERNAME: ${{ secrets.WEBDEPLOY_USERNAME }}
        WEBDEPLOY_PASSWORD: ${{ secrets.WEBDEPLOY_PASSWORD }}
        WEBDEPLOY_SITE: ${{ secrets.WEBDEPLOY_SITE }}
