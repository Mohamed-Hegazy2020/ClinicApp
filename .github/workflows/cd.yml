name: CI/CD - Deploy ClinicApp to MonsterASP.NET

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    # 1️Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2️Setup .NET SDK
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'  # Adjust to your .NET version

    # 3️Restore NuGet packages
    - name: Restore dependencies
      run: dotnet restore ClinicApp.sln

    # 4️Build & publish the solution
    - name: Build and publish
      run: dotnet publish ClinicApp.sln -c Release -o publish

    # 5️Deploy via Web Deploy
    - name: Deploy via Web Deploy
      shell: pwsh
      run: |
        $msdeployPath = "C:\Program Files\IIS\Microsoft Web Deploy V3\msdeploy.exe"

        if (-Not (Test-Path $msdeployPath)) {
            Write-Error "Web Deploy not found at $msdeployPath"
            exit 1
        }

        Write-Host "Deploying ClinicApp via Web Deploy..."

        # Build arguments array using secrets directly
        $msdeployArgs = @(
            "-source", "contentPath=publish"
            "-dest", "contentPath=${Env:WEBDEPLOY_SITE},computerName=${Env:WEBDEPLOY_SERVER},userName=${Env:WEBDEPLOY_USERNAME},password=${Env:WEBDEPLOY_PASSWORD},authType=Basic"
            "-verb:sync"
            "-allowUntrusted"
        )

        # Run Web Deploy
        & $msdeployPath @msdeployArgs
      env:
        WEBDEPLOY_SERVER: ${{ secrets.WEBDEPLOY_SERVER }}
        WEBDEPLOY_USERNAME: ${{ secrets.WEBDEPLOY_USERNAME }}
        WEBDEPLOY_PASSWORD: ${{ secrets.WEBDEPLOY_PASSWORD }}
        WEBDEPLOY_SITE: ${{ secrets.WEBDEPLOY_SITE }}
