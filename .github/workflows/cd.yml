name: CI/CD - Deploy ClinicApp to MonsterASP.NET

on:
  push:
    branches:
      - main  # Trigger deployment on push to main branch

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    # Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v3

    # Setup .NET SDK
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '7.0.x'  # Change to your .NET version

    # Restore NuGet packages
    - name: Restore dependencies
      run: dotnet restore ClinicApp.sln

    # Build & publish the solution
    - name: Build and publish
      run: dotnet publish ClinicApp.sln -c Release -o publish

    # Deploy via Web Deploy
    - name: Deploy via Web Deploy
      shell: pwsh
      run: |
        $publishSettings = @{
          ComputerName = $Env:WEBDEPLOY_SERVER
          UserName     = $Env:WEBDEPLOY_USERNAME
          Password     = $Env:WEBDEPLOY_PASSWORD
          SiteName     = $Env:WEBDEPLOY_SITE
          SourcePath   = "publish"
        }

        $msdeployPath = "C:\Program Files\IIS\Microsoft Web Deploy V3\msdeploy.exe"

        if (-Not (Test-Path $msdeployPath)) {
          Write-Error "Web Deploy not found at $msdeployPath"
          exit 1
        }

        Write-Host "Deploying ClinicApp via Web Deploy..."
        & $msdeployPath `
          -source "contentPath=$($publishSettings.SourcePath)" `
          -dest "contentPath=$($publishSettings.SiteName),computerName=$($publishSettings.ComputerName),userName=$($publishSettings.UserName),password=$($publishSettings.Password),authType=Basic" `
          -allowUntrusted
      env:
        WEBDEPLOY_SERVER: ${{ secrets.WEBDEPLOY_SERVER }}   # e.g., https://yourhost:8172/msdeploy.axd
        WEBDEPLOY_USERNAME: ${{ secrets.WEBDEPLOY_USERNAME }}
        WEBDEPLOY_PASSWORD: ${{ secrets.WEBDEPLOY_PASSWORD }}
        WEBDEPLOY_SITE: ${{ secrets.WEBDEPLOY_SITE }}       # MonsterASP.NET site name
